<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{TIMELINE_TITLE}}</title>

    <!-- vis-timeline CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis-timeline/7.7.3/vis-timeline-graph2d.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>{{TIMELINE_TITLE}}</h1>
            <p class="subtitle">{{TIMELINE_SUBTITLE}}</p>
        </header>

        <div class="filter-controls">
            {{FILTER_BUTTONS}}
        </div>

        <div id="timeline"></div>

        <p class="instructions">Click and drag to pan | Scroll to zoom | Click an event for details</p>

        <div class="info-panel">
            <div class="legend">
                <h3>Timeline Categories</h3>
                {{LEGEND_ITEMS}}
            </div>

            <div class="event-details">
                <h3>Event Details</h3>
                <div id="details-content">
                    <p class="placeholder">Click on a timeline event to see its full details here.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- vis-timeline JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-timeline/7.7.3/vis-timeline-graph2d.min.js"></script>

    <script>
        // Color scheme for categories
        const categoryColors = {{CATEGORY_COLORS}};

        let timeline;
        let timelineData;
        let allItems = [];
        let currentFilter = 'all';

        // Load timeline data
        fetch('timeline.json')
            .then(response => response.json())
            .then(data => {
                initializeTimeline(data);
            })
            .catch(error => {
                console.error('Error loading timeline data:', error);
                document.getElementById('timeline').innerHTML =
                    '<p style="padding: 20px; color: #e74c3c;">Error loading timeline data. Please ensure timeline.json exists.</p>';
            });

        function initializeTimeline(data) {
            // Convert JSON events to vis-timeline format
            allItems = data.events.map((event, index) => {
                const year = parseInt(event.start_date.year);
                // Handle BCE dates (negative years)
                const startDate = new Date(year < 0 ? year : year, 0, 1);

                return {
                    id: `event-${index}`,
                    content: event.text.headline,
                    start: startDate,
                    title: event.notes || event.text.headline,
                    className: event.group.replace(/\s+/g, '-').toLowerCase(),
                    style: `background-color: ${categoryColors[event.group]}; color: white; border-color: ${categoryColors[event.group]};`,
                    category: event.group,
                    eventData: event
                };
            });

            // Create a DataSet
            timelineData = new vis.DataSet(allItems);

            // Timeline options
            const options = {
                width: '100%',
                height: '400px',
                margin: {
                    item: 20,
                    axis: 40
                },
                orientation: 'top',
                zoomMin: 1000 * 60 * 60 * 24 * 365 * {{ZOOM_MIN_YEARS}},
                zoomMax: 1000 * 60 * 60 * 24 * 365 * {{ZOOM_MAX_YEARS}},
                min: new Date({{MIN_YEAR}}, 0, 1),
                max: new Date({{MAX_YEAR}}, 0, 1),
                tooltip: {
                    followMouse: true,
                    template: function(originalItemData, parsedItemData) {
                        return `<div style="max-width: 280px; word-wrap: break-word; overflow-wrap: break-word; white-space: normal;">${originalItemData.title}</div>`;
                    }
                },
                stack: true,
                selectable: true,
                showCurrentTime: false,
                moveable: true,
                zoomable: true
            };

            // Create timeline
            const container = document.getElementById('timeline');
            timeline = new vis.Timeline(container, timelineData, options);

            // Handle event selection
            timeline.on('select', function(properties) {
                if (properties.items.length > 0) {
                    const itemId = properties.items[0];
                    const item = allItems.find(i => i.id === itemId);
                    if (item) {
                        showEventDetails(item.eventData);
                    }
                }
            });

            // Fit timeline to show all events
            timeline.fit();
        }

        function filterCategory(category) {
            currentFilter = category;

            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            if (category === 'all') {
                document.querySelector('.filter-btn.all').classList.add('active');
                timelineData.clear();
                timelineData.add(allItems);
            } else {
                // Find the button with matching data-category
                const btn = document.querySelector(`.filter-btn[data-category="${category}"]`);
                if (btn) btn.classList.add('active');

                const filtered = allItems.filter(item => item.category === category);
                timelineData.clear();
                timelineData.add(filtered);
            }

            timeline.fit();
        }

        function showEventDetails(event) {
            const displayDate = event.start_date.display_date || event.start_date.year;
            const categoryColor = categoryColors[event.group];

            const html = `
                <div class="event-title">${event.text.headline}</div>
                <div class="event-date">
                    <span>${displayDate}</span>
                    <span class="event-category" style="background: ${categoryColor};">${event.group}</span>
                </div>
                <div class="event-description">${event.text.text}</div>
                ${event.notes ? `
                <div class="event-context">
                    <div class="event-context-label">Historical Context</div>
                    <div class="event-context-text">${event.notes}</div>
                </div>
                ` : ''}
            `;

            document.getElementById('details-content').innerHTML = html;
        }
    </script>
</body>
</html>
